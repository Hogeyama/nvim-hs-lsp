dist: xenial

sudo: false

language: c

addons:
  apt:
    packages:
    - libnuma-dev
  apt:
    packages:
    - cabal-install-2.4
    - ghc-8.4.4
    sources:
    - hvr-ghc

cache:
  directories:
  - $HOME/.ghc
  - $HOME/.stack
  - $HOME/.cabal
  - $HOME/.ghcup

before_cache:
- rm -fv $HOME/.stack
- rm -fv $HOME/.cabal/packages/hackage.haskell.org/build-reports.log
# remove files that are regenerated by 'cabal update'
- rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index.*
- rm -fv $HOME/.cabal/packages/hackage.haskell.org/*.json
- rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.cache
- rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar
- rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar.idx
- rm -rfv $HOME/.cabal/packages/head.hackage

before_install:
# [check path and chache]
- export PATH=/opt/ghc/8.4.4/bin:/opt/cabal/2.4/bin:$PATH
- export PATH=$HOME/.local/bin:$HOME/.cabal/bin:$HOME/.ghcup/bin:$PATH
- mkdir -p ~/.local/bin
- find $HOME/.stack -maxdepth 5
- find $HOME/.ghcup -maxdepth 5
- find $HOME/.cabal -maxdepth 5
- find $HOME/.local/bin -maxdepth 5
- which cabal

# [fetch hie repository]
- travis_retry git clone https://github.com/haskell/haskell-ide-engine ~/haskell-ide-engine

# [stack]
- |-
  travis_retry curl -L https://get.haskellstack.org/stable/linux-x86_64.tar.gz |
  tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'
- stack config set system-ghc --global true


# [install hie using cabal]
- (cd $HOME/haskell-ide-engine; git checkout 0.7.0.0)
- (cd $HOME/haskell-ide-engine; stack script install.hs --resolver=lts-12.25 submodules)
- (cd $HOME/haskell-ide-engine; cabal new-install haskell-lsp-0.8.0.1 haskell-lsp-types-0.8.0.1 cabal-plan-0.4.0.0 constrained-dynamic-0.1.0.0 ghc-exactprint-0.5.8.2 haddock-api-2.20.0 haddock-library-1.6.0  haskell-src-exts-1.21.0 hlint-2.1.14 hoogle-5.0.17.5 hsimport-0.8.8 lsp-test-0.5.0.2 monad-dijkstra-0.1.1.2 optparse-simple-0.1.0 pretty-show-1.9.5 syz-0.2.0.0 temporary-1.2.1.1 Diff aeson apply-refact async base bytestring Cabal containers data-default directory filepath fold-debounce gitrev hslogger monad-control monoid-subclasses mtl parsec process safe sorted-list stm tagsoup text transformers unordered-containers vector yaml yi-rope lens)
  # cache
# - (cd $HOME/haskell-ide-engine; cabal new-build hie)
# - (cd $HOME/haskell-ide-engine; cabal new-install hie)

install:
- echo "TODO"
# - stack --no-terminal --install-ghc test --only-dependencies

script:
- find $HOME/.stack -maxdepth 5
- find $HOME/.ghcup -maxdepth 5
- find $HOME/.cabal -maxdepth 5
